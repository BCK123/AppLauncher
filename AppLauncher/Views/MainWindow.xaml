<Window
    x:Class="AppLauncher.Views.MainWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:controls="clr-namespace:HandyControl.Controls;assembly=HandyControl"
    xmlns:converters="clr-namespace:AppLauncher.Converters"
    xmlns:vm="clr-namespace:AppLauncher.ViewModels"
    Title="AppLauncher"
    Width="420"
    Height="520">
    <Window.DataContext>
        <vm:MainViewModel />
    </Window.DataContext>
    <Window.Resources>
        <ResourceDictionary>
            <converters:IconPathToImageConverter x:Key="IconPathToImageConverter" />
            <converters:VisibilityConverter x:Key="VisibilityConverter" />
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="\Resources\Styles.xaml" />
            </ResourceDictionary.MergedDictionaries>
        </ResourceDictionary>
    </Window.Resources>
    <!--  ❗ 在 DockPanel 里： 谁是“最后一个子元素”，谁就会“填满剩余空间”  -->
    <DockPanel>
        <!--  顶部栏：Grid布局 + 引用样式  -->
        <Grid
            Height="60"
            HorizontalAlignment="Stretch"
            Background="White"
            DockPanel.Dock="Top">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto" />
                <!--  标题  -->
                <ColumnDefinition Width="*" />
                <!--  占满中间  -->
                <ColumnDefinition Width="Auto" />
                <!--  右侧按钮  -->
                <ColumnDefinition Width="Auto" />
                <!--  底部  -->
            </Grid.ColumnDefinitions>
            <!--  标题  -->
            <!--  左侧标题  -->
            <TextBlock
                Grid.Column="0"
                Margin="12,0"
                VerticalAlignment="Center"
                Style="{StaticResource TopTitleTextStyle}"
                Text="AppLauncher" />
            <!--  右侧按钮区（关键：放在第 2 列）  -->
            <StackPanel
                Grid.Column="2"
                Margin="0,0,12,0"
                VerticalAlignment="Center"
                Orientation="Horizontal">
                <Button
                    Click="BtnAdd_Click"
                    Cursor="Hand"
                    Style="{StaticResource IconButtonStyle}"
                    ToolTip="添加">
                    <Image
                        Width="18"
                        Height="18"
                        Source="/Resources/icons/add.png" />
                </Button>
                <Button
                    Click="BtnSettings_Click"
                    Style="{StaticResource IconButtonStyle}"
                    ToolTip="设置">
                    <Image
                        Width="18"
                        Height="18"
                        Source="/Resources/icons/setting.png" />
                </Button>
            </StackPanel>
        </Grid>
        <!--  顶部栏：Grid布局 + 引用样式  -->
        <Grid
            Width="410"
            Height="60"
            Background="White"
            DockPanel.Dock="Bottom">
            <!--  使用StackPanel实现横向排列，设置左对齐  -->
            <StackPanel
                HorizontalAlignment="Left"
                VerticalAlignment="Center"
                Orientation="Horizontal">
                <TextBlock Margin="5,0" Text="CPU" />
                <TextBlock Text="{Binding Monitor.CpuUsage, StringFormat={}{0:F2}%}" />
            </StackPanel>
        </Grid>
        <Border
            Margin="8"
            AllowDrop="True"
            Background="WhiteSmoke"
            BorderBrush="Gray"
            BorderThickness="1"
            CornerRadius="4"
            DragOver="Border_DragOver"
            Drop="Border_Drop">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <!--  分类按钮  -->
                    <RowDefinition Height="*" />
                    <!--  图标区域  -->
                </Grid.RowDefinitions>
                <!--  ===== 分类按钮区 =====  -->
                <!--  ===== 分类按钮区（数据绑定） =====  -->
                <ItemsControl
                    Grid.Row="0"
                    Height="36"
                    Margin="8,0,8,0"
                    VerticalAlignment="Top"
                    ItemsSource="{Binding Categories}">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <StackPanel Orientation="Horizontal" />
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Button
                                Margin="4"
                                Padding="10,4"
                                controls:BackgroundSwitchElement.MouseDownBackground="#BDBDBD"
                                controls:BackgroundSwitchElement.MouseHoverBackground="#D2D2D2"
                                Click="Category_Click"
                                Content="{Binding Name}"
                                ContextMenuService.IsEnabled="True">
                                <Button.ContextMenu>
                                    <ContextMenu PlacementTarget="{Binding ElementName=testBtn}" Visibility="{Binding PlacementTarget.Content, RelativeSource={RelativeSource Self}, Converter={StaticResource VisibilityConverter}}">
                                        <MenuItem Click="RenameCategory_Click" Header="重命名" />
                                        <MenuItem Click="DeleteCategory_Click" Header="删除" />
                                    </ContextMenu>
                                </Button.ContextMenu>
                            </Button>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
                <!--  ===== 图标区 =====  -->
                <ScrollViewer Grid.Row="1">
                    <ItemsControl
                        ItemsSource="{Binding ShortcutsView}"
                        ScrollViewer.IsDeferredScrollingEnabled="True"
                        VirtualizingPanel.IsVirtualizing="True"
                        VirtualizingPanel.VirtualizationMode="Recycling">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <WrapPanel IsItemsHost="True" />
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border
                                    Width="96"
                                    Margin="6"
                                    Padding="8"
                                    CornerRadius="8"
                                    Cursor="Hand"
                                    Style="{StaticResource BorderStyle}">
                                    <!--  修复右键菜单绑定  -->
                                    <Border.ContextMenu>
                                        <ContextMenu DataContext="{Binding DataContext, RelativeSource={RelativeSource AncestorType=Window}}">

                                            <MenuItem
                                                Command="{Binding DataContext.RenameCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                                                CommandParameter="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                                                Header="重命名" />
                                            <MenuItem
                                                Command="{Binding DataContext.RemoveCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                                                CommandParameter="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                                                Header="删除" />
                                        </ContextMenu>
                                    </Border.ContextMenu>
                                    <StackPanel HorizontalAlignment="Center">
                                        <Image
                                            Width="48"
                                            Height="48"
                                            Source="{Binding IconPath, Converter={StaticResource IconPathToImageConverter}}" />
                                        <TextBlock
                                            MaxWidth="80"
                                            FontSize="12"
                                            Text="{Binding DisplayName}"
                                            TextAlignment="Center"
                                            TextWrapping="Wrap" />
                                    </StackPanel>
                                    <Border.InputBindings>
                                        <MouseBinding
                                            Command="{Binding DataContext.ItemDoubleClickCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                            CommandParameter="{Binding}"
                                            MouseAction="LeftClick" />
                                    </Border.InputBindings>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>
            </Grid>
        </Border>
    </DockPanel>
</Window>